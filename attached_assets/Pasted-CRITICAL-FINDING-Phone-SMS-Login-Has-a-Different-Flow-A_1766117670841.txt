CRITICAL FINDING: Phone SMS Login Has a Different Flow!
After deep analysis, I found that NOT all login methods are equal. Here's the breakdown:

Login Method Comparison
Feature	Google OAuth	Microsoft OAuth	Email/Password	Phone SMS
Auth Provider	Firebase	Firebase	Firebase	Twilio (NOT Firebase)
User object source	Firebase	Firebase	Firebase	Custom object
Has .getIdToken()?	âœ… Yes	âœ… Yes	âœ… Yes	âŒ NO
Calls /api/auth/token?	âœ… Yes	âœ… Yes	âœ… Yes	âŒ NO
Account linking	âœ… Via backend	âœ… Via backend	âœ… Via backend	âš ï¸ Via Twilio endpoint
Session restoration	âœ… Firebase onAuthStateChanged	âœ… Firebase onAuthStateChanged	âœ… Firebase onAuthStateChanged	âŒ NOT via Firebase
ğŸ”´ THE MAJOR ISSUE: Phone SMS Users
Problem:
Your Phone SMS login uses Twilio, NOT Firebase Auth. This creates a fundamental mismatch:

Login Flow (Phone SMS):

// server/index.js:761-836
POST /api/sms/verify-code
â”œâ”€ Twilio verifies code âœ“
â”œâ”€ Checks authIdentities for existing user (line 802)
â”œâ”€ userId = existingUser ? existingUser.id : formattedPhone (line 812)
â”œâ”€ Creates JWT token (line 814-818)
â””â”€ Returns {userId, token} (line 824-831)

// Client App.jsx:817-866
const phoneUser = {uid: resolvedUserId, phoneNumber: ...} (line 849-854)
await handleAuthSuccess(phoneUser, data.token) (line 859)
â””â”€ Does NOT call /api/auth/token (line 505-507)
â””â”€ Stores token directly with userId

Session Restoration Flow:

// useAuth.js:18-25
useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
    setUser(currentUser);  // â† Phone SMS users: currentUser = NULL!
    setIsLoading(false);
  });
}, []);

Firebase's onAuthStateChanged does NOT detect Twilio SMS logins!

This means:

âœ… Phone user logs in â†’ Trees created successfully
âŒ Page refreshes â†’ Firebase sees NO session
âŒ isAuthenticated = false
âŒ Session restoration NEVER RUNS
âŒ User sees login screen, trees are "lost"
Updated Root Causes by Login Method
âœ… Google/Microsoft/Email - SHOULD Work But May Have Issues:
Possible issues:

UserId mismatch - Account linking returns different userId across sessions
Cookie blocking - Third-party cookies blocked by browser
Token expiry - JWT expired, new token gets different userId
Silent errors - Network issues during restoration
Solutions from my earlier analysis apply: âœ…

âŒ Phone SMS - FUNDAMENTALLY BROKEN:
The issue:

Phone SMS doesn't use Firebase Auth
onAuthStateChanged never fires
isAuthenticated stays false
Session restoration never triggers
User sees login screen every time
Evidence:

// App.jsx:222-231 - Session restoration conditions
if (!isAuthenticated || !user || currentTree || currentView !== 'auth') {
  return; // â† Phone users: isAuthenticated = false, so RETURNS immediately!
}

Why it might work on initial login but not on refresh:

Initial login: handleAuthSuccess manually loads trees â†’ Works âœ…
Page refresh: No Firebase session â†’ No restoration â†’ Broken âŒ
ğŸ”§ FIXES NEEDED
Fix 1: Add Cookie-Based Session Restoration (CRITICAL for Phone SMS)
The phone SMS users rely ONLY on the JWT cookie, not Firebase. You need to detect this:

Add to App.jsx before line 222:

// Restore session from backend cookie alone (for phone SMS users)
useEffect(() => {
  const restoreFromCookie = async () => {
    // Only run if Firebase auth says not authenticated
    if (isAuthenticated || authLoading || currentTree) return;
    if (restorationAttemptedRef.current) return;
    
    console.log('[Cookie Restore] Checking backend auth without Firebase...');
    
    try {
      const backendAuth = await api.auth.check();
      if (backendAuth?.authenticated && backendAuth?.userId) {
        console.log('[Cookie Restore] Found valid backend session:', backendAuth.userId);
        
        // Mark as attempted
        restorationAttemptedRef.current = true;
        
        // Load user data
        const savedUser = await api.users.get(backendAuth.userId);
        setUserProfile(savedUser);
        
        // Load trees
        const userTrees = await api.trees.getAll(backendAuth.userId);
        console.log('[Cookie Restore] Found trees:', userTrees.length);
        
        if (userTrees.length > 0) {
          setCurrentTree(userTrees[0]);
          const treePeopleData = await api.people.getAll(userTrees[0].id);
          const treeRelData = await api.relationships.getAll(userTrees[0].id);
          setPeople(treePeopleData);
          setRelationships(treeRelData);
          setCurrentView("tree-builder");
          console.log('[Cookie Restore] Restored session successfully');
        }
      }
    } catch (error) {
      console.error('[Cookie Restore] Failed:', error);
    }
  };
  
  restoreFromCookie();
}, [authLoading, isAuthenticated, currentTree]);

This allows phone SMS users to restore their session from the backend cookie ALONE.

Fix 2: Add User Fetch Endpoint (Required for Fix 1)
You need to add this endpoint in server/index.js:

// Add after line 945 (after POST /api/users)
app.get('/api/users/:id', authenticateUser, async (req, res) => {
  try {
    const userId = req.params.id;
    
    if (req.userId !== userId) {
      return res.status(403).json({ error: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„' });
    }
    
    const [user] = await db.select().from(users).where(eq(users.id, userId));
    
    if (!user) {
      return res.status(404).json({ error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
    }
    
    res.json(user);
  } catch (error) {
    handleError(res, error, 'User fetch');
  }
});

Fix 3: Verify Account Linking for Phone Numbers
Phone users might have inconsistent userId across logins. Check server/index.js:802-812:

// This might return different userIds!
let existingUser = await findUserByIdentity('phone', formattedPhone);

if (!existingUser) {
  // Falls back to direct lookup
  const [directUser] = await db.select().from(users).where(eq(users.id, formattedPhone));
  if (directUser) {
    existingUser = directUser;
    await linkIdentityToUser(directUser.id, 'phone', formattedPhone, null, true);
  }
}

const userId = existingUser ? existingUser.id : formattedPhone; // â† Might differ!

Make sure the same phone number ALWAYS resolves to the same userId.

Summary
Does my original analysis cover all methods?
Partially:

âœ… Google/Microsoft/Email: My analysis applies fully
âŒ Phone SMS: Has a UNIQUE issue not covered - no Firebase session restoration
Action Items:
Immediate: Implement Fix 1 & 2 (cookie-based restoration) for phone SMS users
Debugging: Check which login method you used when you created the tree
Verification: If you used phone SMS, the issue is 100% what I described
Long-term: Consider migrating phone SMS to Firebase Phone Auth for consistency